{
  "minerType": {
    "name": "Night Update Consolidate (Important Needs Pre-Registered Address)",
    "description": "(Add REGISITED Night/ADA Address in Midnight Dashboard) (Need Python for this to run.",
    "installScript": "import os\r\nimport time\r\nimport subprocess\r\nimport tempfile\r\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\r\n\r\nADB = os.environ.get(\"adb_path\", \"adb\")\r\ndevices = os.environ.get(\"devices\", \"\").split()\r\n\r\n# Nocturne Miner installer - Safe upgrade that preserves settings.json\r\ninstall_script_template = r'''#!/data/data/com.termux/files/usr/bin/bash\r\nset -e\r\nexport DEBIAN_FRONTEND=noninteractive\r\nexport TERMUX_PKG_NO_PROMPT=1\r\nSERIAL_ID=\"{device_id}\"\r\n\r\necho \"==========================================\"\r\necho \"Nocturne Miner Installation/Update v2.3.0\"\r\necho \"==========================================\"\r\n\r\necho \"[*] Preparing environment...\"\r\npkg update -y || true\r\npkg upgrade -y || true\r\npkg install -y wget tar || true\r\n\r\necho \"[*] Disabling nvm auto-load...\"\r\nsed -i '/nvm.sh/d' ~/.bashrc 2>/dev/null || true\r\nsed -i '/NVM_DIR/d' ~/.bashrc 2>/dev/null || true\r\n\r\necho \"[*] Creating working directory...\"\r\nmkdir -p ~/night\r\ncd ~/night\r\n\r\n# Check if settings.json exists (preserve existing config)\r\nHAS_SETTINGS=0\r\nif [ -f ~/night/settings.json ]; then\r\n  echo \"[‚úì] Existing settings.json found - WILL PRESERVE IT\"\r\n  HAS_SETTINGS=1\r\n  # Backup just in case\r\n  cp settings.json settings.json.backup 2>/dev/null || true\r\nfi\r\n\r\necho \"[*] Removing old nocturne-miner binary...\"\r\nrm -f nocturne-miner\r\nrm -f nocturne-miner-android-arm64.tar.gz\r\n\r\necho \"[*] Downloading Nocturne Miner v2.3.0...\"\r\nwget -q --show-progress https://cdn.nocturne.offchain.club/releases/v2.3.0/nocturne-miner-android-arm64.tar.gz\r\n\r\necho \"[*] Extracting new miner binary...\"\r\ntar -xvf nocturne-miner-android-arm64.tar.gz\r\nchmod +x nocturne-miner\r\n\r\n# Only run first-time setup if settings.json doesn't exist\r\nif [ $HAS_SETTINGS -eq 0 ]; then\r\n  echo \"[*] NEW INSTALLATION - Running first-time setup...\"\r\n  printf \"%s\\n\\n\\n\\n\" \"$SERIAL_ID\" | ./nocturne-miner --optimal>/dev/null 2>&1 || true\r\n  \r\n  if [ -f ~/night/settings.json ]; then\r\n    echo \"[‚úì] Initial setup complete! settings.json created.\"\r\n  else\r\n    echo \"[!] WARNING: settings.json not found; setup may have failed.\"\r\n  fi\r\nelse\r\n  echo \"[‚úì] UPGRADE - Skipping first-time setup\"\r\n  echo \"[‚úì] Existing settings.json preserved with mnemonic/miner_id/hwid intact\"\r\n  echo \"[*] New binary ready. Run the miner to auto-populate any new fields.\"\r\nfi\r\n\r\n# Cleanup\r\nrm -f nocturne-miner-android-arm64.tar.gz\r\n\r\necho \"==========================================\"\r\necho \"[‚úì] Installation complete!\"\r\necho \"==========================================\"\r\n'''\r\n\r\ndef adb_cmd(cmd):\r\n    \"\"\"Execute ADB command without console window\"\"\"\r\n    flags = 0x08000000 if os.name == 'nt' else 0  # CREATE_NO_WINDOW on Windows\r\n    return subprocess.run(\r\n        cmd,\r\n        shell=True,\r\n        capture_output=True,\r\n        text=True,\r\n        creationflags=flags\r\n    )\r\n\r\ndef install_on_device(device_id):\r\n    try:\r\n        print(f\"[{device_id}] Starting Nocturne miner installation/update...\")\r\n        \r\n        # Force stop Termux\r\n        adb_cmd(f\"{ADB} -s {device_id} shell am force-stop com.termux\")\r\n        time.sleep(1)\r\n\r\n        # Generate device-specific installer with embedded serial\r\n        script_content = install_script_template.format(device_id=device_id)\r\n        \r\n        # Write with Unix line endings\r\n        with tempfile.NamedTemporaryFile(\r\n            \"w\", \r\n            encoding=\"utf-8\", \r\n            delete=False, \r\n            suffix=\".sh\", \r\n            newline='\\n'\r\n        ) as f:\r\n            f.write(script_content)\r\n            local_script = f.name\r\n\r\n        remote_path = \"/data/local/tmp/nocturne_install.sh\"\r\n        \r\n        # Push installer script\r\n        print(f\"[{device_id}] Pushing installer script...\")\r\n        adb_cmd(f'{ADB} -s {device_id} push \"{local_script}\" \"{remote_path}\"')\r\n        adb_cmd(f\"{ADB} -s {device_id} shell chmod 755 {remote_path}\")\r\n\r\n        # Launch Termux\r\n        print(f\"[{device_id}] Launching Termux...\")\r\n        adb_cmd(f\"{ADB} -s {device_id} shell am start -n com.termux/com.termux.app.TermuxActivity\")\r\n        time.sleep(8)\r\n\r\n        # Execute installer via text input\r\n        print(f\"[{device_id}] Executing installer...\")\r\n        typed_cmd = f\"bash%s{remote_path}\"\r\n        adb_cmd(f'{ADB} -s {device_id} shell input text \"{typed_cmd}\"')\r\n        time.sleep(1)\r\n        adb_cmd(f\"{ADB} -s {device_id} shell input keyevent 66\")\r\n\r\n        # Wait for installation to complete\r\n        print(f\"[{device_id}] Installing (this takes ~25 seconds)...\")\r\n        time.sleep(25)\r\n\r\n        print(f\"[{device_id}] ‚úÖ Nocturne miner v2.3.0 installed successfully!\")\r\n        \r\n        # Cleanup local temp file\r\n        os.unlink(local_script)\r\n        \r\n        return f\"[{device_id}] Success\"\r\n\r\n    except Exception as e:\r\n        print(f\"[{device_id}] ‚ùå Error: {e}\")\r\n        return f\"[{device_id}] Error: {e}\"\r\n\r\ndef main():\r\n    if not devices:\r\n        print(\"‚ùå No devices specified in environment variable\")\r\n        return\r\n\r\n    print(\"=\" * 70)\r\n    print(\"Nocturne Miner Installation/Update - v2.3.0\")\r\n    print(\"=\" * 70)\r\n    print(f\"Devices: {len(devices)}\")\r\n    print(\"Mode: Safe upgrade (preserves existing settings.json)\")\r\n    print(\"=\" * 70)\r\n\r\n    with ThreadPoolExecutor(max_workers=max(1, len(devices))) as executor:\r\n        futures = {executor.submit(install_on_device, device): device for device in devices}\r\n        for future in as_completed(futures):\r\n            print(future.result())\r\n\r\n    print(\"\\n\" + \"=\" * 70)\r\n    print(\"‚úÖ Nocturne miner installation/update complete on all devices!\")\r\n    print(\"=\" * 70)\r\n    print(\"\\nNext steps:\")\r\n    print(\"  1. Existing users: Run script will update donate_to address\")\r\n    print(\"  2. New users: First run created settings.json with serial ID\")\r\n    print(\"=\" * 70)\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
    "runScript": "import os\r\nimport time\r\nimport subprocess\r\nimport tempfile\r\nfrom concurrent.futures import ThreadPoolExecutor, as_completed\r\n\r\n# Environment variables from UI\r\nADB = os.environ.get(\"adb_path\", \"adb\")\r\ndevices = os.environ.get(\"devices\", \"\").split()\r\nthreads = os.environ.get(\"threads\", \"8\")\r\nadditional_flags = os.environ.get(\"additional_flags\", \"10\")  # gen_end_index\r\ndonate_address = os.environ.get(\"wallet_address\", \"\")  # From UI's Wallet Address field\r\n\r\ndef adb_cmd(cmd):\r\n    \"\"\"Execute ADB command without showing console window\"\"\"\r\n    flags = 0x08000000 if os.name == 'nt' else 0  # CREATE_NO_WINDOW on Windows\r\n    return subprocess.run(\r\n        cmd, \r\n        shell=True, \r\n        capture_output=True, \r\n        text=True, \r\n        creationflags=flags\r\n    )\r\n\r\ndef type_in_termux(device_id: str, text: str, press_enter=True, pause=0.35):\r\n    \"\"\"Type text into Termux using ADB input\"\"\"\r\n    escaped = text.replace(\" \", \"%s\")\r\n    adb_cmd(f'{ADB} -s {device_id} shell input text \"{escaped}\"')\r\n    if press_enter:\r\n        time.sleep(0.25)\r\n        adb_cmd(f\"{ADB} -s {device_id} shell input keyevent 66\")\r\n    time.sleep(pause)\r\n\r\ndef create_settings_updater_script(device_id: str):\r\n    \"\"\"\r\n    Create and push a shell script that updates settings.json\r\n    This avoids quoting issues with adb shell input text\r\n    \"\"\"\r\n    # Escape the donate address for sed (forward slashes)\r\n    escaped_addr = donate_address.replace('/', '\\\\/')\r\n    \r\n    # Build the updater script\r\n    updater_script = f'''#!/data/data/com.termux/files/usr/bin/bash\r\nset -e\r\ncd ~/night\r\n\r\necho \"Updating settings.json...\"\r\n\r\n# Update worker_threads\r\nsed -i 's/\"worker_threads\":[[:space:]]*[0-9]*/\"worker_threads\": {threads}/' settings.json\r\n\r\n# Update gen_end_index\r\nsed -i 's/\"gen_end_index\":[[:space:]]*[0-9]*/\"gen_end_index\": {additional_flags}/' settings.json\r\n'''\r\n    \r\n    # Only add donate_to update if address is provided\r\n    if donate_address and donate_address.strip():\r\n        updater_script += f'''\r\n# Update donate_to address\r\nsed -i 's/\"donate_to\":[[:space:]]*\"[^\"]*\"/\"donate_to\": \"{escaped_addr}\"/' settings.json\r\n'''\r\n    \r\n    updater_script += '''\r\necho \"Settings updated successfully!\"\r\ncat settings.json\r\n'''\r\n    \r\n    # Write to temp file with Unix line endings\r\n    with tempfile.NamedTemporaryFile(\r\n        \"w\", \r\n        encoding=\"utf-8\", \r\n        delete=False, \r\n        suffix=\".sh\",\r\n        newline='\\n'\r\n    ) as f:\r\n        f.write(updater_script)\r\n        local_script = f.name\r\n    \r\n    # Push to device\r\n    remote_path = \"/data/local/tmp/update_nocturne.sh\"\r\n    adb_cmd(f'{ADB} -s {device_id} push \"{local_script}\" \"{remote_path}\"')\r\n    adb_cmd(f\"{ADB} -s {device_id} shell chmod 755 {remote_path}\")\r\n    \r\n    # Cleanup local file\r\n    os.unlink(local_script)\r\n    \r\n    return remote_path\r\n\r\ndef run_nocturne_on_device(device_id: str):\r\n    \"\"\"Start Nocturne miner on a single device\"\"\"\r\n    try:\r\n        print(f\"[{device_id}] Starting Nocturne miner...\")\r\n        \r\n        # Step 1: Restart Termux\r\n        print(f\"[{device_id}] Restarting Termux...\")\r\n        adb_cmd(f\"{ADB} -s {device_id} shell am force-stop com.termux\")\r\n        time.sleep(1)\r\n        adb_cmd(f\"{ADB} -s {device_id} shell am start -n com.termux/com.termux.app.TermuxActivity\")\r\n        time.sleep(6)\r\n        \r\n        # Step 2: Create and push settings updater script\r\n        print(f\"[{device_id}] Creating settings updater...\")\r\n        updater_path = create_settings_updater_script(device_id)\r\n        time.sleep(0.5)\r\n        \r\n        # Step 3: Navigate to miner directory\r\n        print(f\"[{device_id}] Navigating to ~/night...\")\r\n        type_in_termux(device_id, \"cd ~/night\")\r\n        \r\n        # Step 4: Execute the updater script\r\n        print(f\"[{device_id}] Updating settings.json...\")\r\n        type_in_termux(device_id, f\"bash {updater_path}\", pause=2.0)\r\n        \r\n        # Step 5: Start the miner\r\n        print(f\"[{device_id}] Starting nocturne-miner...\")\r\n        type_in_termux(device_id, \"./nocturne-miner --optimal\", pause=2.5)\r\n        \r\n        # Step 6: Press Enter 3 times for defaults\r\n        print(f\"[{device_id}] Accepting default prompts...\")\r\n        for _ in range(3):\r\n            adb_cmd(f\"{ADB} -s {device_id} shell input keyevent 66\")\r\n            time.sleep(0.6)\r\n        \r\n        # Step 7: Keep screen awake\r\n        adb_cmd(f\"{ADB} -s {device_id} shell svc power stayon true\")\r\n        \r\n        print(f\"[{device_id}] ‚úÖ Nocturne miner started successfully!\")\r\n        return f\"[{device_id}] Success\"\r\n        \r\n    except Exception as e:\r\n        print(f\"[{device_id}] ‚ùå Error: {e}\")\r\n        return f\"[{device_id}] Error: {e}\"\r\n\r\ndef main():\r\n    if not devices:\r\n        print(\"‚ùå No devices specified in environment variable\")\r\n        return\r\n    \r\n    if not donate_address:\r\n        print(\"‚ö†Ô∏è  Warning: No donation address specified - donate_to will not be updated\")\r\n    \r\n    print(\"=\" * 60)\r\n    print(\"Starting Nocturne Miner\")\r\n    print(\"=\" * 60)\r\n    print(f\"Devices: {len(devices)}\")\r\n    print(f\"Threads (worker_threads): {threads}\")\r\n    print(f\"Gen End Index (additional_flags): {additional_flags}\")\r\n    if donate_address:\r\n        print(f\"Donate To: {donate_address[:20]}...{donate_address[-10:]}\")\r\n    else:\r\n        print(\"Donate To: (unchanged)\")\r\n    print(\"=\" * 60)\r\n    \r\n    # Run on all devices in parallel\r\n    with ThreadPoolExecutor(max_workers=max(1, len(devices))) as executor:\r\n        futures = {executor.submit(run_nocturne_on_device, device): device for device in devices}\r\n        for future in as_completed(futures):\r\n            print(future.result())\r\n    \r\n    print(\"\\n‚úÖ Nocturne miner deployment complete!\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()",
    "stopScript": "# nocturne_stop.py\r\n# Stop Nocturne miner by killing Termux (and try to kill nocturne-miner if it escaped).\r\n\r\nimport os, subprocess, concurrent.futures\r\n\r\nADB     = os.environ.get(\"adb_path\", \"adb\")\r\ndevices = os.environ.get(\"devices\", \"\").split()\r\n\r\ndef adb(cmd):\r\n    return subprocess.run(cmd, shell=True, capture_output=True, text=True)\r\n\r\ndef stop_on(device_id: str):\r\n    try:\r\n        # Kill any stray Nocturne miner processes (if it‚Äôs running outside Termux session)\r\n        adb(f'{ADB} -s {device_id} shell \"pkill -f nocturne-miner 2>/dev/null || true\"')\r\n\r\n        # Force-stop Termux (kills active foreground miner session)\r\n        adb(f\"{ADB} -s {device_id} shell am force-stop com.termux\")\r\n\r\n        print(f\"[{device_id}] üõë Nocturne miner stopped successfully.\")\r\n    except Exception as e:\r\n        print(f\"[{device_id}] ‚ùå Error stopping miner: {e}\")\r\n\r\ndef main():\r\n    if not devices:\r\n        print(\"No devices in $devices\")\r\n        return\r\n\r\n    print(\"=== Stopping Nocturne Miner on All Devices ===\")\r\n\r\n    with concurrent.futures.ThreadPoolExecutor(max_workers=max(1, len(devices))) as ex:\r\n        futs = [ex.submit(stop_on, d) for d in devices]\r\n        for f in concurrent.futures.as_completed(futs):\r\n            f.result()\r\n\r\n    print(\"‚úÖ All stop commands sent.\")\r\n\r\nif __name__ == \"__main__\":\r\n    main()\r\n",
    "uninstallScript": "",
    "installTermux": false,
    "installScriptLanguage": "Python",
    "runScriptLanguage": "Python",
    "stopScriptLanguage": "Python",
    "uninstallScriptLanguage": "Lua",
    "id": "bb5069b2-2bcf-4cea-bfbb-a17ee5cf02ea"
  },
  "timestamp": "2025-11-17T20:57:47.134Z",
  "version": "1.0.0"
}